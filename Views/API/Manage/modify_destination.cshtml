@using SL.Util
@using System.Text.RegularExpressions
@{
    RequestUtil req = new RequestUtil();
    int id = req.Int("id");
    string name = req.String("name", false, "请填写用户名");
    string content = req.String("content", false, "请填写正文");
    var middlePic = req.File("middlePic");
    var largePic = req.File("largePic");

    content = Regex.Replace(content, @"<script.*?>[\s\S]*</script>", "", RegexOptions.IgnoreCase);

    if (req.HasError)
    {
        Json.Write(new { success = false, msg = req.FirstError, errors = req.GetErrors() }, Output);
    }
    else
    {
        string middlePicSrc = middlePic.Save();
        string largePicSrc = largePic.Save();

        int count = SL.Data.SQL.Execute("update Destination set Name=@p1,Content=@p2,MiddlePic=@p3,LargePic=@p4,Favorite=@p5 where ID=@p0", id, name, content, middlePicSrc, largePicSrc);

        if (count <= 0)
        {
            Json.Write(new { success = false, msg = "添加失败" }, Output);
        }
        else
        {
            Json.Write(new { success = true, msg = "添加成功", data = new { Name = name, Content = content, MiddlePic = middlePicSrc, LargePic = largePicSrc, Favorite = 0 } }, Output);
        }
    }
}
